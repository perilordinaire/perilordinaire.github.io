<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACC ‚Äî Analyse de Corpus</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #F5F2ED;
    --surface:   #FFFFFF;
    --border:    #DDD8CF;
    --ink:       #1C1A17;
    --ink-2:     #5C5750;
    --ink-3:     #9C9690;
    --accent:    #B85C38;
    --accent-lt: #F0E0D8;
    --navy:      #1E2D40;
    --navy-lt:   #EDF1F5;
    --green:     #2D6A4F;
    --green-lt:  #D8EDE5;
    --amber:     #92600A;
    --amber-lt:  #FEF3C7;
    --radius:    6px;
    --shadow:    0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 15px; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    min-height: 100vh;
    font-weight: 400;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--navy);
    color: #fff;
    padding: 0 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,.2);
  }
  .brand { font-family: 'Libre Baskerville', serif; font-size: 1.05rem; letter-spacing: .03em; }
  .brand span { color: #A8BFD4; font-style: italic; font-weight: 400; }
  .progress-bar-wrap { display:flex; align-items:center; gap:.75rem; font-size:.8rem; color:#A8BFD4; }
  .progress-bar { width:120px; height:6px; background:rgba(255,255,255,.15); border-radius:3px; overflow:hidden; }
  .progress-bar-fill { height:100%; background:#6FA8C8; border-radius:3px; transition: width .4s ease; }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  nav {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    padding: 0 2rem;
    gap: 0;
  }
  .tab-btn {
    padding: .75rem 1.25rem;
    font-family: 'DM Sans', sans-serif;
    font-size: .82rem;
    font-weight: 500;
    color: var(--ink-2);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    letter-spacing: .04em;
    text-transform: uppercase;
    transition: color .15s, border-color .15s;
  }
  .tab-btn:hover { color: var(--ink); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-badge {
    display: inline-flex; align-items:center; justify-content:center;
    min-width: 18px; height: 18px; padding: 0 4px;
    background: var(--navy-lt); color: var(--navy);
    border-radius: 9px; font-size: .7rem; margin-left: .4rem; font-weight:600;
  }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .tab-panel { display: none; padding: 2rem; max-width: 1100px; margin: 0 auto; }
  .tab-panel.active { display: block; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }
  .card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    background: #FAFAF8;
  }
  .card-title {
    font-family: 'Libre Baskerville', serif;
    font-size: .95rem; font-weight: 700; color: var(--ink);
  }
  .card-body { padding: 1.5rem; }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
  .form-group { display: flex; flex-direction: column; gap: .35rem; }
  .form-group.full { grid-column: 1 / -1; }
  label { font-size: .78rem; font-weight: 600; color: var(--ink-2); text-transform: uppercase; letter-spacing: .05em; }
  input[type=text], input[type=number], select, textarea {
    padding: .55rem .75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-family: 'DM Sans', sans-serif;
    font-size: .9rem;
    color: var(--ink);
    background: var(--surface);
    transition: border-color .15s, box-shadow .15s;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--navy);
    box-shadow: 0 0 0 3px rgba(30,45,64,.1);
  }
  textarea { resize: vertical; min-height: 90px; line-height: 1.6; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    display: inline-flex; align-items: center; gap: .4rem;
    padding: .5rem 1.1rem;
    font-family: 'DM Sans', sans-serif;
    font-size: .83rem; font-weight: 600;
    border-radius: var(--radius);
    border: 1px solid transparent;
    cursor: pointer;
    transition: all .15s;
    letter-spacing: .02em;
  }
  .btn-primary { background: var(--navy); color: #fff; border-color: var(--navy); }
  .btn-primary:hover { background: #2A3F57; }
  .btn-accent { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-accent:hover { background: #A04F30; }
  .btn-outline { background: transparent; color: var(--ink-2); border-color: var(--border); }
  .btn-outline:hover { background: var(--bg); color: var(--ink); }
  .btn-ghost { background: transparent; color: var(--ink-3); border-color: transparent; font-size:.8rem; padding:.35rem .7rem; }
  .btn-ghost:hover { color: var(--accent); }
  .btn-sm { padding: .3rem .7rem; font-size: .78rem; }
  .btn-danger { background:#FEE2E2; color:#B91C1C; border-color:#FECACA; }
  .btn-danger:hover { background:#FCA5A5; }
  .btn-green { background: var(--green); color:#fff; border-color:var(--green); }
  .btn-green:hover { background:#245A42; }

  /* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
  .data-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
  .data-table th {
    text-align: left; padding: .6rem 1rem;
    font-size: .72rem; font-weight: 600; text-transform: uppercase; letter-spacing: .06em;
    color: var(--ink-2);
    background: #FAFAF8;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .data-table td { padding: .65rem 1rem; border-bottom: 1px solid #F0EDE8; vertical-align: middle; }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: #FAFAF8; }
  .data-table .mono { font-family: 'DM Mono', monospace; font-size: .78rem; color: var(--ink-2); }

  /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
  .badge {
    display: inline-block; padding: .2rem .55rem;
    border-radius: 3px; font-size: .72rem; font-weight: 600;
    font-family: 'DM Mono', monospace;
  }
  .badge-P { background: var(--green-lt); color: var(--green); }
  .badge-A { background: var(--navy-lt); color: var(--navy); }
  .badge-M { background: var(--amber-lt); color: var(--amber); }
  .badge-E { background: #F3E8FF; color: #7C3AED; }
  .badge-I { background: #E0F2FE; color: #0369A1; }
  .badge-D { background: var(--accent-lt); color: var(--accent); }
  .badge-type-S { background: var(--navy-lt); color: var(--navy); }
  .badge-type-I { background: var(--amber-lt); color: var(--amber); }
  .badge-coded { background: var(--green-lt); color: var(--green); }
  .badge-uncoded { background: #FEE2E2; color: #B91C1C; }

  /* ‚îÄ‚îÄ DIMENSION FORM ‚îÄ‚îÄ */
  .dim-block {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 1rem;
    overflow: hidden;
  }
  .dim-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: .75rem 1rem;
    background: #FAFAF8;
    cursor: pointer;
    user-select: none;
  }
  .dim-header:hover { background: var(--bg); }
  .dim-title { font-weight: 600; font-size: .9rem; display:flex; align-items:center; gap:.6rem; }
  .dim-num { 
    width:24px; height:24px; border-radius:50%;
    background: var(--navy); color:#fff;
    display:flex; align-items:center; justify-content:center;
    font-size:.72rem; font-weight:700; font-family:'DM Mono',monospace;
    flex-shrink:0;
  }
  .dim-body { padding: 1rem; display:none; border-top: 1px solid var(--border); }
  .dim-body.open { display:block; }
  .indicators { margin-bottom: 1rem; }
  .indicators summary { font-size:.78rem; color:var(--ink-2); cursor:pointer; margin-bottom:.5rem; font-weight:500; }
  .indicators-grid { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; margin-top:.5rem; }
  .ind-col h5 { font-size:.72rem; text-transform:uppercase; letter-spacing:.05em; color:var(--ink-3); margin-bottom:.4rem; }
  .ind-col ul { list-style:none; }
  .ind-col li { font-size:.8rem; color:var(--ink-2); padding:.15rem 0; padding-left:.8rem; position:relative; line-height:1.4; }
  .ind-col li::before { content:'‚Ä∫'; position:absolute; left:0; color:var(--ink-3); }
  .radio-group { display:flex; gap:.75rem; flex-wrap:wrap; margin-top:.5rem; }
  .radio-option { display:flex; align-items:center; gap:.4rem; }
  .radio-option input[type=radio] { accent-color: var(--navy); }
  .radio-option label { font-size:.85rem; font-weight:400; text-transform:none; letter-spacing:0; color:var(--ink); cursor:pointer; }
  .dim-hint { font-size:.8rem; color:var(--ink-2); font-style:italic; margin-bottom:.75rem; }
  .cond-field { margin-top:.75rem; padding:.75rem; background:var(--accent-lt); border-radius:var(--radius); border:1px solid #E8C5B4; display:none; }
  .cond-field.visible { display:block; }

  /* ‚îÄ‚îÄ SYNTH√àSE ‚îÄ‚îÄ */
  .stat-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-bottom:1.5rem; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:1.25rem; text-align:center; }
  .stat-num { font-family:'Libre Baskerville',serif; font-size:2rem; font-weight:700; color:var(--navy); }
  .stat-label { font-size:.78rem; color:var(--ink-2); margin-top:.25rem; }
  .bar-chart { margin-top:.5rem; }
  .bar-row { display:flex; align-items:center; gap:.75rem; margin-bottom:.6rem; font-size:.82rem; }
  .bar-label { width:200px; flex-shrink:0; color:var(--ink-2); }
  .bar-track { flex:1; height:18px; background:#F0EDE8; border-radius:3px; overflow:hidden; display:flex; }
  .bar-seg { height:100%; transition: width .4s ease; }
  .bar-seg-P { background:var(--green); }
  .bar-seg-A { background:#94A3B8; }
  .bar-seg-M { background:#F59E0B; }
  .bar-pct { min-width:35px; text-align:right; font-family:'DM Mono',monospace; font-size:.75rem; color:var(--ink-2); }

  /* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ */
  .export-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  .export-card { border:1px solid var(--border); border-radius:var(--radius); padding:1.25rem; }
  .export-card h4 { font-weight:600; margin-bottom:.4rem; font-size:.9rem; }
  .export-card p { font-size:.8rem; color:var(--ink-2); margin-bottom:1rem; line-height:1.5; }
  .export-desc-code { font-family:'DM Mono',monospace; font-size:.73rem; color:var(--accent); background:var(--accent-lt); padding:.15rem .35rem; border-radius:3px; }

  /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
  .alert { padding:.75rem 1rem; border-radius:var(--radius); font-size:.85rem; margin-bottom:1rem; display:flex; align-items:flex-start; gap:.6rem; }
  .alert-info { background:var(--navy-lt); color:var(--navy); border:1px solid #C0D0E0; }
  .alert-warn { background:var(--amber-lt); color:var(--amber); border:1px solid #FDE68A; }
  .alert-success { background:var(--green-lt); color:var(--green); border:1px solid #A7D7C5; }

  /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
  .empty-state { text-align:center; padding:3rem; color:var(--ink-3); }
  .empty-state p { font-size:.9rem; margin-top:.5rem; }
  .section-label { font-size:.72rem; font-weight:600; text-transform:uppercase; letter-spacing:.07em; color:var(--ink-3); margin-bottom:1rem; }
  .flex-between { display:flex; align-items:center; justify-content:space-between; }
  .flex-gap { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .mt-1 { margin-top:.5rem; }
  .mt-2 { margin-top:1rem; }
  .mt-3 { margin-top:1.5rem; }
  details > summary { list-style:none; }
  details > summary::-webkit-details-marker { display:none; }
  .extract-text-preview { font-size:.82rem; color:var(--ink-2); font-style:italic; max-width:320px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .coded-check { color: var(--green); }
  
  @media (max-width:700px) {
    .form-grid, .form-grid-3, .export-grid, .stat-grid, .indicators-grid { grid-template-columns:1fr; }
    .tab-btn { padding:.6rem .7rem; font-size:.72rem; letter-spacing:.02em; }
    .tab-panel { padding:1rem; }
  }
</style>
</head>
<body>

<header>
  <div class="brand">ACC <span>‚Äî Analyse de Corpus</span></div>
  <div class="progress-bar-wrap">
    <span id="progress-text">0 / 0 extraits cod√©s</span>
    <div class="progress-bar"><div class="progress-bar-fill" id="progress-fill" style="width:0%"></div></div>
  </div>
</header>

<nav>
  <button class="tab-btn active" onclick="showTab('corpus')">Corpus <span class="tab-badge" id="badge-corpus">0</span></button>
  <button class="tab-btn" onclick="showTab('extraits')">Extraits <span class="tab-badge" id="badge-extraits">0</span></button>
  <button class="tab-btn" onclick="showTab('codage')">Codage <span class="tab-badge" id="badge-codage">0</span></button>
  <button class="tab-btn" onclick="showTab('synthese')">Synth√®se</button>
  <button class="tab-btn" onclick="showTab('export')">Export CSV</button>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 1 : CORPUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel active" id="tab-corpus">
  <div class="card">
    <div class="card-header">
      <span class="card-title">Ajouter un document</span>
    </div>
    <div class="card-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Auteur(s)</label>
          <input type="text" id="c-auteur" placeholder="Bernard, P.-Y." />
        </div>
        <div class="form-group">
          <label>Ann√©e</label>
          <input type="number" id="c-annee" placeholder="2019" min="2010" max="2030" />
        </div>
        <div class="form-group full">
          <label>Titre complet</label>
          <input type="text" id="c-titre" placeholder="Le d√©crochage scolaire en lyc√©e professionnel..." />
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="c-type">
            <option value="">‚Äî Choisir ‚Äî</option>
            <option>Scientifique</option>
            <option>Institutionnel</option>
          </select>
        </div>
        <div class="form-group">
          <label>Focus</label>
          <select id="c-focus">
            <option value="">‚Äî Choisir ‚Äî</option>
            <option>LP</option>
            <option>G√©n√©ral</option>
            <option>LP + G√©n√©ral</option>
          </select>
        </div>
        <div class="form-group">
          <label>P√©riode</label>
          <select id="c-periode">
            <option value="">‚Äî Choisir ‚Äî</option>
            <option>2015-2018</option>
            <option>2019-2022</option>
            <option>2023-2025</option>
          </select>
        </div>
        <div class="form-group">
          <label>Accessible (PDF)</label>
          <select id="c-accessible">
            <option>Oui</option>
            <option>Non</option>
          </select>
        </div>
      </div>
      <div style="margin-top:1rem; text-align:right;">
        <button class="btn btn-primary" onclick="addCorpus()">Ôºã Ajouter au corpus</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="card-title">Documents du corpus</span>
      <div class="flex-gap">
        <span id="corpus-count-label" style="font-size:.8rem; color:var(--ink-2)"></span>
      </div>
    </div>
    <div id="corpus-table-wrap">
      <div class="empty-state"><p>Aucun document ajout√©.</p></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 2 : EXTRAITS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-extraits">
  <div class="card">
    <div class="card-header">
      <span class="card-title">Ajouter un extrait</span>
    </div>
    <div class="card-body">
      <div class="alert alert-info">‚Ñπ L'ID de l'extrait est g√©n√©r√© automatiquement (ex : 001-1). S√©lectionnez le document source, puis la section.</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Document source</label>
          <select id="e-doc" onchange="updateExtractCount()">
            <option value="">‚Äî S√©lectionner un document ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label>Section</label>
          <select id="e-section">
            <option>D√©but</option>
            <option>Milieu</option>
            <option>Fin</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Texte de l'extrait</label>
          <textarea id="e-texte" rows="5" placeholder="Coller ici le texte de l'extrait (paragraphe complet)..." oninput="countWords()"></textarea>
        </div>
        <div class="form-group">
          <label>Nombre de mots (auto)</label>
          <input type="number" id="e-mots" readonly style="background:#FAFAF8;color:var(--ink-2);" value="0" />
        </div>
        <div class="form-group" id="extract-slot-info" style="align-self:flex-end;">
          <label>&nbsp;</label>
          <div style="font-size:.82rem; color:var(--ink-2); padding:.55rem 0;" id="slot-hint"></div>
        </div>
      </div>
      <div style="margin-top:1rem; text-align:right;">
        <button class="btn btn-primary" onclick="addExtrait()">Ôºã Ajouter l'extrait</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="card-title">Extraits enregistr√©s</span>
    </div>
    <div id="extraits-table-wrap">
      <div class="empty-state"><p>Aucun extrait ajout√©.</p></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 3 : CODAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-codage">
  <div style="display:grid; grid-template-columns:300px 1fr; gap:1.5rem; align-items:start;">
    <!-- Liste extraits -->
    <div>
      <div class="section-label">Extraits √† coder</div>
      <div id="coding-list">
        <div class="empty-state" style="padding:2rem;"><p>Ajoutez des extraits d'abord.</p></div>
      </div>
    </div>
    <!-- Formulaire de codage -->
    <div id="coding-form-wrap">
      <div class="empty-state" style="padding:3rem; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);">
        <p style="font-size:1rem;">‚Üê S√©lectionnez un extrait pour le coder</p>
        <p style="margin-top:.5rem;">Les indicateurs de chaque dimension s'afficheront ici.</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 4 : SYNTH√àSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-synthese">
  <div class="stat-grid" id="stat-cards">
    <div class="stat-card"><div class="stat-num" id="s-docs">0</div><div class="stat-label">Documents</div></div>
    <div class="stat-card"><div class="stat-num" id="s-extraits">0</div><div class="stat-label">Extraits</div></div>
    <div class="stat-card"><div class="stat-num" id="s-coded">0%</div><div class="stat-label">Cod√©s</div></div>
  </div>
  <div class="card">
    <div class="card-header"><span class="card-title">Fr√©quences par dimension</span></div>
    <div class="card-body" id="synth-bars">
      <div class="empty-state"><p>Codez des extraits pour voir les r√©sultats.</p></div>
    </div>
  </div>
  <div class="card" id="comp-card">
    <div class="card-header"><span class="card-title">Scientifiques vs Institutionnels</span></div>
    <div class="card-body" id="comp-table-wrap">
      <div class="empty-state"><p>Donn√©es insuffisantes.</p></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 5 : EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-export">
  <div class="alert alert-success">‚úì Les CSV export√©s sont encod√©s en <strong>UTF-8 avec BOM</strong>, s√©parateur <strong>point-virgule</strong> ‚Äî compatibles avec Jamovi et Sphinx (logiciel d'enqu√™te).</div>

  <div class="export-grid">
    <div class="export-card">
      <h4>üìÑ corpus.csv</h4>
      <p>M√©tadonn√©es des 20 documents : ID, Auteur, Ann√©e, Titre, Type, Focus, P√©riode, Accessible.<br>
      √Ä importer dans Jamovi comme table de r√©f√©rence ou dans Sphinx comme base documentaire.</p>
      <button class="btn btn-outline" onclick="exportCSV('corpus')">T√©l√©charger corpus.csv</button>
    </div>
    <div class="export-card">
      <h4>üìÑ extraits.csv</h4>
      <p>Table des extraits : ID_Extrait, ID_Doc, Section, Texte_Extrait, Nb_mots.<br>
      Permet de retrouver chaque extrait cod√© et de le relier √† sa source.</p>
      <button class="btn btn-outline" onclick="exportCSV('extraits')">T√©l√©charger extraits.csv</button>
    </div>
    <div class="export-card">
      <h4>üìä codage.csv</h4>
      <p>Table brute du codage : ID_Extrait, D1‚ÄìD6, D2_Cible, Notes.<br>
      Structure miroir du fichier Excel mod√®le. √Ä utiliser dans Sphinx pour les tris √† plat.</p>
      <button class="btn btn-outline" onclick="exportCSV('codage')">T√©l√©charger codage.csv</button>
    </div>
    <div class="export-card" style="border-color:var(--navy); background:var(--navy-lt);">
      <h4>üìä codage_enrichi.csv <span style="font-size:.72rem;color:var(--accent);margin-left:.3rem;">RECOMMAND√â</span></h4>
      <p>Table <strong>jointe</strong> : codage + m√©tadonn√©es corpus (Auteur, Ann√©e, Type, Focus, P√©riode).<br>
      <strong>Format id√©al pour Jamovi</strong> : toutes les variables dans un seul fichier, pr√™t pour les analyses crois√©es et le test du œá¬≤.</p>
      <button class="btn btn-primary" onclick="exportCSV('enrichi')">T√©l√©charger codage_enrichi.csv</button>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header"><span class="card-title">Sauvegarde / Restauration</span></div>
    <div class="card-body">
      <p style="font-size:.85rem; color:var(--ink-2); margin-bottom:1rem;">Exportez toutes vos donn√©es en JSON pour les sauvegarder ou les transf√©rer sur un autre navigateur.</p>
      <div class="flex-gap">
        <button class="btn btn-outline" onclick="exportJSON()">üíæ Sauvegarder tout (JSON)</button>
        <button class="btn btn-outline" onclick="document.getElementById('import-json').click()">üìÇ Restaurer depuis JSON</button>
        <input type="file" id="import-json" accept=".json" style="display:none" onchange="importJSON(event)">
        <button class="btn btn-danger btn-sm" onclick="resetAll()">üóë Tout effacer</button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let DB = {
  corpus: [],
  extraits: [],
  codages: {}
};

const DIMS = [
  {
    id:'D1', label:'R√©ification',
    question:'Le d√©crochage est-il trait√© comme une ¬´ chose ¬ª poss√©d√©e par l\'√©l√®ve ?',
    options:[{v:'P',l:'Pr√©sente'},{v:'A',l:'Absente'},{v:'M',l:'Mixte'}],
    indicators:{
      present:['¬´ LE d√©crochage ¬ª comme sujet grammatical','¬´ UN d√©crocheur ¬ª (cat√©gorie d\'individu)','Profil de d√©crocheur','M√©taphores spatiales : tombe, d√©croche, glisse'],
      absent:['Processus de d√©crochage','D√©sengagement progressif','Les d√©crochages (pluriel, h√©t√©rog√©n√©it√©)','Analyse relationnelle institution-√©l√®ve']
    }
  },
  {
    id:'D2', label:'Vocabulaire clinique',
    question:'Un vocabulaire m√©dical/pathologique est-il utilis√© ?',
    options:[{v:'P',l:'Pr√©sent'},{v:'A',l:'Absent'},{v:'M',l:'Mixte'}],
    indicators:{
      present:['Termes m√©dicaux : fragile, en souffrance, √† risque, sympt√¥me','Termes th√©rapeutiques : traiter, rem√©dier, soigner','Lutte contre (comme une maladie)','D√©pister, pr√©venir (vocabulaire pr√©ventif m√©dical)'],
      absent:['Vocabulaire sociologique : position, trajectoire, structure','Vocabulaire neutre : situation, parcours, exp√©rience','Pas de pathologisation']
    },
    conditional:{
      triggerValue:'P',
      field:'D2_Cible',
      label:'Cible du vocabulaire clinique',
      options:[{v:'LP',l:'Cibl√© sur le LP sp√©cifiquement'},{v:'GEN',l:'G√©n√©ral (pas sp√©cifique au LP)'}]
    }
  },
  {
    id:'D3', label:'Focalisation',
    question:'O√π est situ√© le probl√®me ? Dans l\'√©l√®ve ou dans l\'institution ?',
    options:[{v:'E',l:'√âl√®ve dominant'},{v:'I',l:'Institution dominante'},{v:'M',l:'Mixte assum√©e'}],
    indicators:{
      present:['Caract√©ristiques individuelles (motivation, capacit√©s)','D√©faillances personnelles ou familiales','Facteurs de risque individuels','Solutions de rem√©diation individuelle'],
      absent:['Organisation du syst√®me scolaire','M√©canismes de s√©lection','Inad√©quation p√©dagogique','Conditions structurelles']
    },
    presentLabel:'Focalisation √âl√®ve',
    absentLabel:'Focalisation Institution'
  },
  {
    id:'D4', label:'Reconnaissance des acquis hors √©cole',
    question:'Les savoirs/comp√©tences acquis hors √©cole sont-ils √©voqu√©s ?',
    options:[{v:'P',l:'Pr√©sente'},{v:'A',l:'Absente'},{v:'M',l:'Ambigu√´'}],
    indicators:{
      present:['Mention explicite de comp√©tences hors √©cole','Valorisation des savoirs pratiques','√âvocation de parcours alternatifs','R√©f√©rence √† l\'apprentissage informel','Mention de la VAE ou dispositifs similaires'],
      absent:['Aucune mention des acquis hors √©cole','Seuls les dipl√¥mes scolaires sont mentionn√©s','Le d√©crocheur d√©fini uniquement par ce qu\'il n\'a PAS']
    }
  },
  {
    id:'D5', label:'Norme implicite',
    question:'Les normes scolaires sont-elles explicit√©es ou pr√©suppos√©es ?',
    options:[{v:'I',l:'Implicite (pr√©suppos√©e)'},{v:'E',l:'Explicite (questionn√©e)'},{v:'M',l:'Mixte'}],
    indicators:{
      present:['¬´ Pr√©maturit√© ¬ª sans d√©finition','¬´ Dur√©e normale ¬ª non questionn√©e','¬´ Sortie pr√©coce ¬ª sans pr√©ciser par rapport √† quoi','Norme du baccalaur√©at comme √©vidence'],
      absent:['Questionnement de ce qui est ¬´ normal ¬ª','Historicisation de la norme','Reconnaissance du caract√®re socialement construit','Mise en perspective comparative (autres pays)']
    },
    presentLabel:'Norme IMPLICITE',
    absentLabel:'Norme EXPLICITE'
  },
  {
    id:'D6', label:'Statut du LP',
    question:'Le LP est-il d√©fini par d√©faut (√©cart au LGT) ou reconnu comme ayant une logique propre ?',
    options:[{v:'D',l:'Par d√©faut (√©cart LGT)'},{v:'P',l:'Normativit√© propre'},{v:'M',l:'Mixte'}],
    indicators:{
      present:['Comparaison syst√©matique d√©favorable au LGT','Voie de garage, second choix','√âl√®ves en difficult√© orient√©s en LP','Hi√©rarchie des fili√®res naturalis√©e'],
      absent:['Rapport au savoir sp√©cifique (pratique) reconnu','Valorisation de comp√©tences techniques','LP comme logique alternative (pas inf√©rieure)','Critique explicite de la hi√©rarchie des fili√®res']
    },
    presentLabel:'LP PAR D√âFAUT',
    absentLabel:'LP NORMATIVIT√â PROPRE'
  }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save() { localStorage.setItem('acc_db', JSON.stringify(DB)); updateUI(); }
function load() {
  const d = localStorage.getItem('acc_db');
  if (d) try { DB = JSON.parse(d); } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(id) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  event.currentTarget.classList.add('active');
  if (id === 'synthese') renderSynthese();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CORPUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genId(arr) {
  if (arr.length === 0) return '001';
  const nums = arr.map(d => parseInt(d.id)).filter(n => !isNaN(n));
  return String(Math.max(...nums) + 1).padStart(3,'0');
}

function addCorpus() {
  const auteur = document.getElementById('c-auteur').value.trim();
  const annee  = document.getElementById('c-annee').value.trim();
  const titre  = document.getElementById('c-titre').value.trim();
  const type   = document.getElementById('c-type').value;
  const focus  = document.getElementById('c-focus').value;
  const per    = document.getElementById('c-periode').value;
  const acc    = document.getElementById('c-accessible').value;
  if (!auteur || !titre || !type || !focus || !per) { alert('Veuillez remplir Auteur, Titre, Type, Focus et P√©riode.'); return; }
  DB.corpus.push({ id: genId(DB.corpus), auteur, annee, titre, type, focus, periode: per, accessible: acc });
  ['c-auteur','c-annee','c-titre'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('c-type').value = '';
  document.getElementById('c-focus').value = '';
  document.getElementById('c-periode').value = '';
  save();
}

function deleteCorpus(id) {
  if (!confirm('Supprimer ce document et ses extraits ?')) return;
  DB.corpus = DB.corpus.filter(d => d.id !== id);
  DB.extraits = DB.extraits.filter(e => e.doc_id !== id);
  DB.extraits.forEach(e => { if (DB.codages[e.id]) delete DB.codages[e.id]; });
  save();
}

function renderCorpus() {
  const wrap = document.getElementById('corpus-table-wrap');
  document.getElementById('corpus-count-label').textContent = `${DB.corpus.length} document${DB.corpus.length>1?'s':''}`;
  document.getElementById('badge-corpus').textContent = DB.corpus.length;
  if (DB.corpus.length === 0) { wrap.innerHTML = '<div class="empty-state"><p>Aucun document ajout√©.</p></div>'; return; }
  const rows = DB.corpus.map(d => {
    const extraitCount = DB.extraits.filter(e => e.doc_id === d.id).length;
    const tbadge = d.type === 'Scientifique' ? 'badge-type-S' : 'badge-type-I';
    return `<tr>
      <td class="mono">${d.id}</td>
      <td><strong>${esc(d.auteur)}</strong> ${d.annee ? `<span style="color:var(--ink-2)">(${d.annee})</span>`:''}</td>
      <td style="max-width:280px;"><span style="font-size:.83rem">${esc(d.titre)}</span></td>
      <td><span class="badge ${tbadge}">${d.type === 'Scientifique' ? 'Scient.' : 'Instit.'}</span></td>
      <td style="font-size:.82rem;color:var(--ink-2)">${d.focus}</td>
      <td style="font-size:.82rem;color:var(--ink-2)">${d.periode}</td>
      <td><span style="font-size:.75rem;color:${extraitCount>=3?'var(--green)':'var(--ink-3)'}">${extraitCount}/3 extraits</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="deleteCorpus('${d.id}')">‚úï</button></td>
    </tr>`;
  }).join('');
  wrap.innerHTML = `<table class="data-table"><thead><tr>
    <th>ID</th><th>Auteur</th><th>Titre</th><th>Type</th><th>Focus</th><th>P√©riode</th><th>Extraits</th><th></th>
  </tr></thead><tbody>${rows}</tbody></table>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXTRAITS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateExtractCount() {
  const docId = document.getElementById('e-doc').value;
  const hint = document.getElementById('slot-hint');
  if (!docId) { hint.textContent = ''; return; }
  const count = DB.extraits.filter(e => e.doc_id === docId).length;
  hint.textContent = `${count}/3 extrait${count>1?'s':''} pour ce document`;
  hint.style.color = count >= 3 ? 'var(--accent)' : 'var(--ink-2)';
}

function countWords() {
  const t = document.getElementById('e-texte').value.trim();
  const n = t ? t.split(/\s+/).length : 0;
  document.getElementById('e-mots').value = n;
}

function genExtractId(docId) {
  const existing = DB.extraits.filter(e => e.doc_id === docId);
  return `${docId}-${existing.length + 1}`;
}

function addExtrait() {
  const docId = document.getElementById('e-doc').value;
  const section = document.getElementById('e-section').value;
  const texte = document.getElementById('e-texte').value.trim();
  const mots = parseInt(document.getElementById('e-mots').value) || 0;
  if (!docId) { alert('S√©lectionnez un document source.'); return; }
  if (!texte) { alert('Ajoutez le texte de l\'extrait.'); return; }
  const existing = DB.extraits.filter(e => e.doc_id === docId);
  if (existing.length >= 3) { alert('Ce document a d√©j√† 3 extraits (maximum recommand√©).'); return; }
  DB.extraits.push({ id: genExtractId(docId), doc_id: docId, section, texte, mots });
  document.getElementById('e-texte').value = '';
  document.getElementById('e-mots').value = '0';
  save();
}

function deleteExtrait(id) {
  if (!confirm('Supprimer cet extrait (le codage associ√© sera perdu) ?')) return;
  DB.extraits = DB.extraits.filter(e => e.id !== id);
  if (DB.codages[id]) delete DB.codages[id];
  save();
}

function renderExtraits() {
  const wrap = document.getElementById('extraits-table-wrap');
  const sel = document.getElementById('e-doc');
  // update select
  const curVal = sel.value;
  sel.innerHTML = '<option value="">‚Äî S√©lectionner un document ‚Äî</option>' +
    DB.corpus.map(d => `<option value="${d.id}" ${curVal===d.id?'selected':''}>${d.id} ‚Äî ${esc(d.auteur)} (${d.annee||''})</option>`).join('');

  document.getElementById('badge-extraits').textContent = DB.extraits.length;
  if (DB.extraits.length === 0) { wrap.innerHTML = '<div class="empty-state"><p>Aucun extrait ajout√©.</p></div>'; return; }
  const rows = DB.extraits.map(e => {
    const doc = DB.corpus.find(d => d.id === e.doc_id) || {};
    const coded = DB.codages[e.id] ? '<span class="badge badge-coded">Cod√©</span>' : '<span class="badge badge-uncoded">√Ä coder</span>';
    return `<tr>
      <td class="mono">${e.id}</td>
      <td class="mono">${e.doc_id}</td>
      <td style="font-size:.82rem;color:var(--ink-2)">${esc(doc.auteur||'')} ${doc.annee?`(${doc.annee})`:''}</td>
      <td style="font-size:.82rem">${e.section}</td>
      <td><span class="extract-text-preview">${esc(e.texte)}</span></td>
      <td style="font-size:.8rem;color:var(--ink-3)">${e.mots} mots</td>
      <td>${coded}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="deleteExtrait('${e.id}')">‚úï</button></td>
    </tr>`;
  }).join('');
  wrap.innerHTML = `<table class="data-table"><thead><tr>
    <th>ID Extrait</th><th>ID Doc</th><th>Document</th><th>Section</th><th>Texte (aper√ßu)</th><th>Mots</th><th>Statut</th><th></th>
  </tr></thead><tbody>${rows}</tbody></table>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CODAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeExtrait = null;

function renderCodingList() {
  const list = document.getElementById('coding-list');
  document.getElementById('badge-codage').textContent = Object.keys(DB.codages).length;
  if (DB.extraits.length === 0) {
    list.innerHTML = '<div class="empty-state" style="padding:2rem;"><p>Ajoutez des extraits.</p></div>';
    return;
  }
  list.innerHTML = DB.extraits.map(e => {
    const doc = DB.corpus.find(d => d.id === e.doc_id) || {};
    const coded = DB.codages[e.id];
    const isActive = activeExtrait === e.id;
    return `<div onclick="selectExtrait('${e.id}')" style="
      padding:.75rem 1rem; cursor:pointer; border-radius:var(--radius);
      margin-bottom:.4rem; border:1px solid ${isActive?'var(--navy)':'var(--border)'};
      background:${isActive?'var(--navy-lt)':'var(--surface)'};
      transition: all .15s;
    ">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <span style="font-family:'DM Mono',monospace;font-size:.78rem;font-weight:600;color:${isActive?'var(--navy)':'var(--ink-2)'}">${e.id}</span>
        ${coded ? '<span style="font-size:.7rem;color:var(--green)">‚úì Cod√©</span>' : '<span style="font-size:.7rem;color:#B91C1C">‚óØ √Ä coder</span>'}
      </div>
      <div style="font-size:.8rem;margin-top:.25rem;color:var(--ink-2)">${esc(doc.auteur||'')} ‚Äî ${e.section}</div>
    </div>`;
  }).join('');
}

function selectExtrait(id) {
  activeExtrait = id;
  renderCodingList();
  const e = DB.extraits.find(x => x.id === id);
  const doc = DB.corpus.find(d => d.id === e.doc_id) || {};
  const existing = DB.codages[id] || {};

  let html = `
    <div class="card">
      <div class="card-header">
        <span class="card-title">${id} ‚Äî ${esc(doc.auteur||'')} <span style="font-weight:400;color:var(--ink-2)">(${doc.annee||''})</span></span>
        <span style="font-size:.8rem;color:var(--ink-2)">${e.section} ¬∑ ${e.mots} mots</span>
      </div>
      <div class="card-body">
        <details style="margin-bottom:1rem;">
          <summary style="cursor:pointer;font-size:.82rem;color:var(--ink-2);font-weight:500;">‚ñ∂ Afficher le texte de l'extrait</summary>
          <div style="margin-top:.75rem;padding:1rem;background:var(--bg);border-radius:var(--radius);font-size:.85rem;line-height:1.7;color:var(--ink);border-left:3px solid var(--accent);">${esc(e.texte)}</div>
        </details>`;

  DIMS.forEach(dim => {
    const savedVal = existing[dim.id] || '';
    const savedCond = existing[dim.id+'_Cible'] || '';
    const pLabel = dim.presentLabel || 'Indicateurs PR√âSENTS';
    const aLabel = dim.absentLabel || 'Indicateurs ABSENTS';

    html += `<div class="dim-block">
      <div class="dim-header" onclick="toggleDim(this)">
        <div class="dim-title">
          <span class="dim-num">${dim.id.replace('D','')}</span>
          ${dim.label}
          <span style="font-size:.75rem;font-weight:400;color:var(--ink-2);font-style:italic;">${dim.question}</span>
        </div>
        <div style="display:flex;align-items:center;gap:.5rem;">
          ${savedVal ? `<span class="badge badge-${savedVal}">${savedVal}</span>` : '<span style="font-size:.75rem;color:var(--ink-3)">‚Äî</span>'}
          <span style="color:var(--ink-3);font-size:.9rem;">‚Ä∫</span>
        </div>
      </div>
      <div class="dim-body">
        <details class="indicators">
          <summary>üìã Afficher les indicateurs</summary>
          <div class="indicators-grid">
            <div class="ind-col">
              <h5>${pLabel}</h5>
              <ul>${dim.indicators.present.map(i=>`<li>${i}</li>`).join('')}</ul>
            </div>
            <div class="ind-col">
              <h5>${aLabel}</h5>
              <ul>${dim.indicators.absent.map(i=>`<li>${i}</li>`).join('')}</ul>
            </div>
          </div>
        </details>
        <div class="radio-group">
          ${dim.options.map(o => `
            <label class="radio-option">
              <input type="radio" name="dim_${id}_${dim.id}" value="${o.v}" ${savedVal===o.v?'checked':''} 
                onchange="handleDimChange('${id}','${dim.id}',this.value)">
              <label style="cursor:pointer">${o.v} ‚Äî ${o.l}</label>
            </label>`).join('')}
        </div>
        ${dim.conditional ? `
          <div class="cond-field ${savedVal === dim.conditional.triggerValue ? 'visible' : ''}" id="cond_${id}_${dim.id}">
            <label style="font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--accent);">${dim.conditional.label}</label>
            <div class="radio-group mt-1">
              ${dim.conditional.options.map(o=>`
                <label class="radio-option">
                  <input type="radio" name="cond_${id}_${dim.id}" value="${o.v}" ${savedCond===o.v?'checked':''}
                    onchange="handleCondChange('${id}','${dim.conditional.field}',this.value)">
                  <label style="cursor:pointer">${o.v} ‚Äî ${o.l}</label>
                </label>`).join('')}
            </div>
          </div>` : ''}
      </div>
    </div>`;
  });

  html += `
        <div class="form-group" style="margin-top:1rem;">
          <label>Notes et exemples pr√©cis</label>
          <textarea id="notes_${id}" rows="3" placeholder="Ex : Vocabulaire 'fragile' (p.3), '√† risque' (p.7)...">${esc(existing.Notes||'')}</textarea>
        </div>
        <div style="margin-top:1rem;display:flex;justify-content:flex-end;gap:.75rem;">
          <button class="btn btn-green" onclick="saveCodage('${id}')">‚úì Enregistrer le codage</button>
        </div>
      </div>
    </div>`;

  document.getElementById('coding-form-wrap').innerHTML = html;
}

function toggleDim(header) {
  const body = header.nextElementSibling;
  body.classList.toggle('open');
}

function handleDimChange(extractId, dimId, value) {
  if (!DB.codages[extractId]) DB.codages[extractId] = {};
  DB.codages[extractId][dimId] = value;
  const dim = DIMS.find(d => d.id === dimId);
  if (dim && dim.conditional) {
    const condEl = document.getElementById(`cond_${extractId}_${dimId}`);
    if (condEl) condEl.classList.toggle('visible', value === dim.conditional.triggerValue);
    if (value !== dim.conditional.triggerValue) {
      DB.codages[extractId][dim.conditional.field] = '-';
    }
  }
}

function handleCondChange(extractId, field, value) {
  if (!DB.codages[extractId]) DB.codages[extractId] = {};
  DB.codages[extractId][field] = value;
}

function saveCodage(extractId) {
  if (!DB.codages[extractId]) DB.codages[extractId] = {};
  const notes = document.getElementById(`notes_${extractId}`);
  if (notes) DB.codages[extractId].Notes = notes.value.trim();
  // ensure all dims recorded
  const missing = DIMS.filter(d => !DB.codages[extractId][d.id]);
  if (missing.length > 0) {
    if (!confirm(`Attention : ${missing.map(d=>d.label).join(', ')} non cod√©(es). Enregistrer quand m√™me ?`)) return;
  }
  save();
  alert('‚úì Codage enregistr√© !');
  selectExtrait(extractId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYNTH√àSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSynthese() {
  document.getElementById('s-docs').textContent = DB.corpus.length;
  document.getElementById('s-extraits').textContent = DB.extraits.length;
  const pct = DB.extraits.length ? Math.round(Object.keys(DB.codages).length / DB.extraits.length * 100) : 0;
  document.getElementById('s-coded').textContent = pct + '%';

  const codedExtraits = DB.extraits.filter(e => DB.codages[e.id]);
  if (codedExtraits.length === 0) {
    document.getElementById('synth-bars').innerHTML = '<div class="empty-state"><p>Codez des extraits pour voir les r√©sultats.</p></div>';
    document.getElementById('comp-table-wrap').innerHTML = '<div class="empty-state"><p>Donn√©es insuffisantes.</p></div>';
    return;
  }
  const n = codedExtraits.length;

  // Frequencies per dimension
  const dimDefs = [
    {id:'D1', label:'D1 ‚Äî R√©ification', vals:['P','A','M'], labels:['Pr√©sente','Absente','Mixte']},
    {id:'D2', label:'D2 ‚Äî Vocab. clinique', vals:['P','A','M'], labels:['Pr√©sent','Absent','Mixte']},
    {id:'D3', label:'D3 ‚Äî Focalisation', vals:['E','I','M'], labels:['√âl√®ve','Institution','Mixte']},
    {id:'D4', label:'D4 ‚Äî Acquis hors √©cole', vals:['P','A','M'], labels:['Pr√©sente','Absente','Ambigu√´']},
    {id:'D5', label:'D5 ‚Äî Norme', vals:['I','E','M'], labels:['Implicite','Explicite','Mixte']},
    {id:'D6', label:'D6 ‚Äî Statut LP', vals:['D','P','M'], labels:['Par d√©faut','Normativit√© propre','Mixte']},
  ];

  let barsHtml = `<div style="margin-bottom:.5rem; display:flex; gap:1.5rem; font-size:.75rem;">
    <span style="display:flex;align-items:center;gap:.4rem;"><span style="width:12px;height:12px;background:var(--green);border-radius:2px;display:inline-block"></span>Val. 1</span>
    <span style="display:flex;align-items:center;gap:.4rem;"><span style="width:12px;height:12px;background:#94A3B8;border-radius:2px;display:inline-block"></span>Val. 2</span>
    <span style="display:flex;align-items:center;gap:.4rem;"><span style="width:12px;height:12px;background:#F59E0B;border-radius:2px;display:inline-block"></span>Mixte</span>
  </div>`;

  dimDefs.forEach(dim => {
    const counts = dim.vals.map(v => codedExtraits.filter(e => DB.codages[e.id][dim.id] === v).length);
    const pcts = counts.map(c => (c/n*100).toFixed(0));
    const segs = ['bar-seg-P','bar-seg-A','bar-seg-M'];
    barsHtml += `<div class="bar-row">
      <div class="bar-label">${dim.label}</div>
      <div class="bar-track">
        ${dim.vals.map((v,i) => `<div class="bar-seg ${segs[i]}" style="width:${pcts[i]}%" title="${dim.labels[i]}: ${pcts[i]}%"></div>`).join('')}
      </div>
      <div class="bar-pct">${pcts[0]}%</div>
      <div style="font-size:.72rem;color:var(--ink-3);min-width:120px;padding-left:.5rem">${dim.vals.map((v,i)=>`${v}:${counts[i]}`).join(' ¬∑ ')}</div>
    </div>`;
  });
  document.getElementById('synth-bars').innerHTML = barsHtml;

  // Scientific vs Institutional
  const scExtraits = codedExtraits.filter(e => {
    const doc = DB.corpus.find(d => d.id === e.doc_id);
    return doc && doc.type === 'Scientifique';
  });
  const insExtraits = codedExtraits.filter(e => {
    const doc = DB.corpus.find(d => d.id === e.doc_id);
    return doc && doc.type === 'Institutionnel';
  });

  if (scExtraits.length === 0 || insExtraits.length === 0) {
    document.getElementById('comp-table-wrap').innerHTML = '<div class="alert alert-warn">‚ö† Il faut des extraits cod√©s des deux types (Scientifique ET Institutionnel) pour la comparaison.</div>';
    return;
  }

  let compRows = dimDefs.map(dim => {
    const scPct = (scExtraits.filter(e => DB.codages[e.id][dim.id] === dim.vals[0]).length / scExtraits.length * 100).toFixed(0);
    const insPct = (insExtraits.filter(e => DB.codages[e.id][dim.id] === dim.vals[0]).length / insExtraits.length * 100).toFixed(0);
    const diff = scPct - insPct;
    return `<tr>
      <td style="font-size:.82rem">${dim.label}</td>
      <td><span style="font-family:'DM Mono',monospace">${scPct}%</span></td>
      <td><span style="font-family:'DM Mono',monospace">${insPct}%</span></td>
      <td><span style="font-family:'DM Mono',monospace;color:${diff>0?'var(--accent)':'var(--green)'}">${diff>0?'+':''}${diff}pp</span></td>
    </tr>`;
  }).join('');

  document.getElementById('comp-table-wrap').innerHTML = `
    <p style="font-size:.8rem;color:var(--ink-2);margin-bottom:1rem;">% d'extraits avec la valeur 1 (Pr√©sent/√âl√®ve/Implicite/D√©faut) selon le type de source ‚Äî ${scExtraits.length} extraits scientifiques ¬∑ ${insExtraits.length} institutionnels</p>
    <table class="data-table">
      <thead><tr><th>Dimension</th><th>Scientifiques</th><th>Institutionnels</th><th>√âcart</th></tr></thead>
      <tbody>${compRows}</tbody>
    </table>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT CSV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toBOM(s) { return '\uFEFF' + s; }
function csvRow(arr) { return arr.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(';') + '\r\n'; }

function exportCSV(type) {
  let content = '', filename = '';
  const BOM = '\uFEFF';

  if (type === 'corpus') {
    filename = 'corpus.csv';
    content = BOM + csvRow(['ID','Auteur','Ann√©e','Titre','Type','Focus','P√©riode','Accessible']);
    DB.corpus.forEach(d => content += csvRow([d.id,d.auteur,d.annee,d.titre,d.type,d.focus,d.periode,d.accessible]));
  }
  else if (type === 'extraits') {
    filename = 'extraits.csv';
    content = BOM + csvRow(['ID_Extrait','ID_Doc','Section','Texte_Extrait','Nb_mots']);
    DB.extraits.forEach(e => content += csvRow([e.id,e.doc_id,e.section,e.texte,e.mots]));
  }
  else if (type === 'codage') {
    filename = 'codage.csv';
    content = BOM + csvRow(['ID_Extrait','D1_R√©ification','D2_Vocab_Clinique','D2_Cible','D3_Focalisation','D4_Acquis','D5_Norme','D6_LP','Notes']);
    DB.extraits.forEach(e => {
      const c = DB.codages[e.id] || {};
      content += csvRow([e.id,c.D1||'',c.D2||'',c.D2_Cible||'-',c.D3||'',c.D4||'',c.D5||'',c.D6||'',c.Notes||'']);
    });
  }
  else if (type === 'enrichi') {
    filename = 'codage_enrichi.csv';
    content = BOM + csvRow(['ID_Extrait','ID_Doc','Auteur','Ann√©e','Type','Focus','P√©riode','Section','Nb_mots','D1_R√©ification','D2_Vocab_Clinique','D2_Cible','D3_Focalisation','D4_Acquis','D5_Norme','D6_LP','Notes']);
    DB.extraits.forEach(e => {
      const doc = DB.corpus.find(d => d.id === e.doc_id) || {};
      const c = DB.codages[e.id] || {};
      content += csvRow([e.id,e.doc_id,doc.auteur||'',doc.annee||'',doc.type||'',doc.focus||'',doc.periode||'',e.section,e.mots,c.D1||'',c.D2||'',c.D2_Cible||'-',c.D3||'',c.D4||'',c.D5||'',c.D6||'',c.Notes||'']);
    });
  }

  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(DB, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'acc_sauvegarde.json'; a.click();
  URL.revokeObjectURL(url);
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.corpus && data.extraits && data.codages) {
        DB = data;
        save();
        alert('‚úì Donn√©es restaur√©es avec succ√®s !');
      } else { alert('Fichier JSON invalide.'); }
    } catch { alert('Erreur lors de la lecture du fichier.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function resetAll() {
  if (!confirm('‚ö† Effacer TOUTES les donn√©es (corpus, extraits, codages) ? Cette action est irr√©versible.')) return;
  DB = { corpus: [], extraits: [], codages: {} };
  activeExtrait = null;
  save();
  alert('Donn√©es effac√©es.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GLOBAL UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateUI() {
  renderCorpus();
  renderExtraits();
  renderCodingList();
  updateProgress();
}

function updateProgress() {
  const total = DB.extraits.length;
  const coded = Object.keys(DB.codages).length;
  const pct = total ? coded / total * 100 : 0;
  document.getElementById('progress-text').textContent = `${coded} / ${total} extraits cod√©s`;
  document.getElementById('progress-fill').style.width = pct + '%';
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
load();
updateUI();
</script>
</body>
</html>
